!function(t){var e=function(){this.options={eras:[],range:!1,mode:null,autocalculate:!0},this.coordinates={startSkate:{min:0,max:0},endSkate:{min:0,max:0}},this.selector=null,this.startSkate=null,this.endSkate=null,this.progressBar=null,this.enabledSkater=null,this.selected={start:0,end:0},this.setEvendHandlers=function(){var e=this;e.startSkate.on("mousedown touchstart",function(){e.enabledSkater="startSkate"}),e.options.range&&e.endSkate.on("mousedown touchstart",function(){e.enabledSkater="endSkate"}),t(document).on("mouseup touchend",function(){e.checkSelection(null),e.enabledSkater=null}),t(document).on("mousemove touchmove",function(t){if(e.enabledSkater){e.checkSelection(null);var s=t.pageX-e.selector.offset().left;s<e.coordinates[e.enabledSkater].min?s=e.coordinates[e.enabledSkater].min:s>e.coordinates[e.enabledSkater].max&&(s=e.coordinates[e.enabledSkater].max),e[e.enabledSkater].css("left",s)}}),this.progressBar.on("click tap",function(t){e.progressBarSelection(t.pageX)})},this.init=function(){var s=this,a=[];this.selector.addClass("ds-container"),this.options.autocalculate&&e.autocalculateErasSizes(this.options.eras),console.log("this.options.eras",this.options.eras),t.each(this.options.eras,function(t,e){for(var n='<div class="ds-era" data-era="'+t+'" style="width:'+e.size+"%; background-color:"+e.color+'"><span class="ds-era-title">'+e.name+'</span><span class="ds-era-start">'+e.start+"</span>",i=e.exclude?DateSlider.getExcludedYearsPlain(e):[],r=e.end-e.start-i.length,o=s.selector.width()/100*e.size,d=o/r,l=e.start;l<e.end;l++)~i.indexOf(l)||(s.selected.start||(s.selected.start=l),n+='<span class="ds-era-item" data-year="'+l+'" style="width:'+d+'px"></span>');t===s.options.eras.length-1&&(n+='<span class="ds-era-end">'+e.end+"</span>",s.selected.end=e.end),n+="</div>",a.push(n)});var n='<div class="ds-skate"><span class="ds-skate-year-mark">'+s.selected.start+'</span></div><div class="ds-progress">'+a.join("")+" </div>";this.options.range&&(n+='<div class="ds-end-skate"><span class="ds-skate-year-mark">'+s.selected.end+"</span></div>"),this.selector.html(n),this.startSkate=this.selector.find(".ds-skate"),this.options.range&&(this.endSkate=this.selector.find(".ds-end-skate")),this.progressBar=this.selector.find(".ds-progress"),this.selector.attr("ondragstart","return false"),this.calculateAndSetCoordinates(),this.setEvendHandlers()},this.checkSelection=function(e){var s,a=this,n=!!e,i=null;if(n)this.options.range||(i="start"),this.options.range&&parseInt(this.endSkate.css("left"),10)-e<e-parseInt(this.startSkate.css("left"),10)?(this.endSkate.css("left",e),i="end"):(this.startSkate.css("left",e),i="start");else{if(!this[this.enabledSkater])return;e=parseInt(this[this.enabledSkater].css("left"),10)}this.progressBar.find(".ds-era-item").each(function(n,i){var r=t(i).offset().left-a.selector.offset().left;return e>=r&&r+t(i).width()>e?(s=+t(i).attr("data-year"),!1):void 0}),i=i||(this.enabledSkater?this.enabledSkater.split("Skate")[0]:null),s&&s!==this.selected[i]&&(this.selected[i]=+s,this.updateSelectedYear(),this.options.onChange&&"function"==typeof this.options.onChange&&this.onChange())},this.onChange=function(){this.options.range?this.options.onChange(this.selected):this.options.onChange(this.selected.start)},this.progressBarSelection=function(e){this.checkSelection(e-t(".ds-container").offset().left)},this.updateSelectedYear=function(){this.updateCoordinates(),this.startSkate.children(".ds-skate-year-mark").html(this.selected.start),this.options.range&&this.endSkate.children(".ds-skate-year-mark").html(this.selected.end)},this.updateCoordinates=function(){this.options.range&&(this.coordinates.startSkate.max=parseInt(this.endSkate.css("left"),10),this.coordinates.endSkate.min=parseInt(this.startSkate.css("left"),10))},this.calculateAndSetCoordinates=function(){this.coordinates.startSkate.max=this.selector.width()-this.startSkate.width()-parseInt(this.startSkate.css("border-width"),10),this.options.range&&(this.coordinates.endSkate.max=this.selector.width()-this.endSkate.width()-parseInt(this.endSkate.css("border-width"),10))},this.select=function(e){if(e!==this.selectedYear){var s=t('.ds-era-item[data-year="'+e+'"]');if(!s.length)return console.warn("DateSlider -> select: element `"+e+"` is not found."),this;var a=s.offset().left;this.skate.css("left",a),this.selectedYear=e,this.updateSelectedYear(),this.options.onChange&&"function"==typeof this.options.onChange&&this.onChange()}return this}};e.autocalculateErasSizes=function(t){var e=t.reduce(function(t,e,s){return 1===s?t.end-t.start+(e.end-e.start):(console.log("prev",t),t+(e.end-e.start))});return t.map(function(t){t.size=100/e*(t.end-t.start)})},e.getExcludedYearsPlain=function(e){var s=[];return t.each(e.exclude,function(t,e){if("object"==typeof e&&e.start&&e.end)for(var a=e.start;a<=e.end;a++)s.push(a);else s.push(e)}),s},t.fn.extend({rangeRover:function(s){var a=new e;return a.options=t.extend(a.options,s),a.selector=t(this),a.init(),s.onInit&&"function"==typeof s.onInit&&s.onInit(),a}})}(jQuery);

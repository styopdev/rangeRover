!function(a){var b=function(){this.options={categories:[],range:!1,mode:"plain",autocalculate:!0,color:"#e8e8e8"},this.coordinates={startSkate:{min:0,max:0},endSkate:{min:0,max:0}},this.selector=null,this.startSkate=null,this.endSkate=null,this.progressBar=null,this.enabledSkater=null,this.selected={start:0,end:0},this.setEvendHandlers=function(){var b=this;b.startSkate.on("mousedown touchstart",function(){b.enabledSkater="startSkate"}),b.options.range&&b.endSkate.on("mousedown touchstart",function(){b.enabledSkater="endSkate"}),a(document).on("mouseup touchend",function(){b.checkSelection(null),b.enabledSkater=null}),a(document).on("mousemove touchmove",function(a){if(b.enabledSkater){b.checkSelection(null);var c=a.pageX-b.selector.offset().left;c<b.coordinates[b.enabledSkater].min?c=b.coordinates[b.enabledSkater].min:c>b.coordinates[b.enabledSkater].max&&(c=b.coordinates[b.enabledSkater].max),b[b.enabledSkater].css("left",c)}}),this.progressBar.on("click tap",function(a){b.progressBarSelection(a.pageX)})},this.init=function(){var c=this,d=[];"plain"===this.options.mode&&(c.options.data.size=100,c.options.data=[this.options.data]),c.selector.addClass("ds-container"),c.options.autocalculate&&"categorized"===this.options.mode&&b.autocalculateCategoriesSizes(c.options.data),a.each(c.options.data,function(a,e){for(var f=e.exclude?b.getExcludedValuesPlain(e):[],g='<div class="ds-category" data-category="'+a+'" style="width:'+e.size+"%; background-color:"+(e.color||c.options.color)+'"><span class="ds-category-title"></span><span class="ds-category-start">'+e.start+"</span>",h=e.end-e.start-f.length,i=c.selector.width()/100*e.size,j=i/h,k=e.start;k<e.end;k++)~f.indexOf(k)||(c.selected.start||(c.selected.start=k),g+='<span class="ds-item" data-year="'+k+'" style="width:'+j+'px"></span>');a===c.options.data.length-1&&(g+='<span class="ds-category-end">'+e.end+"</span>",c.selected.end=e.end),g+="</div>",d.push(g)});var e='<div class="ds-skate"><span class="ds-skate-year-mark">'+c.selected.start+'</span></div><div class="ds-progress">'+d.join("")+" </div>";this.options.range&&(e+='<div class="ds-end-skate"><span class="ds-skate-year-mark">'+c.selected.end+"</span></div>"),this.selector.html(e),this.startSkate=this.selector.find(".ds-skate"),this.options.range&&(this.endSkate=this.selector.find(".ds-end-skate")),this.progressBar=this.selector.find(".ds-progress"),this.selector.attr("ondragstart","return false"),this.calculateAndSetCoordinates(),this.setEvendHandlers()},this.checkSelection=function(b){var c,d=this,e=!!b,f=null;if(e)d.options.range||(f="start"),d.options.range&&parseInt(d.endSkate.css("left"),10)-b<b-parseInt(d.startSkate.css("left"),10)?(d.endSkate.css("left",b),f="end"):(d.startSkate.css("left",b),f="start");else{if(!d[d.enabledSkater])return;b=parseInt(d[d.enabledSkater].css("left"),10)}d.progressBar.find(".ds-item").each(function(e,f){var g=a(f).offset().left-d.selector.offset().left;if(g<=b&&g+a(f).width()>b)return c=+a(f).attr("data-year"),!1}),f=f||(d.enabledSkater?d.enabledSkater.split("Skate")[0]:null),c&&c!==this.selected[f]&&(d.selected[f]=+c,d.updateSelectedYear(),d.options.onChange&&"function"==typeof d.options.onChange&&d.onChange())},this.onChange=function(){this.options.range?this.options.onChange(this.selected):this.options.onChange(this.selected.start)},this.progressBarSelection=function(b){this.checkSelection(b-a(".ds-container").offset().left)},this.updateSelectedYear=function(){this.updateCoordinates(),this.startSkate.children(".ds-skate-year-mark").html(this.selected.start),this.options.range&&this.endSkate.children(".ds-skate-year-mark").html(this.selected.end)},this.updateCoordinates=function(){this.options.range&&(this.coordinates.startSkate.max=parseInt(this.endSkate.css("left"),10),this.coordinates.endSkate.min=parseInt(this.startSkate.css("left"),10))},this.calculateAndSetCoordinates=function(){this.coordinates.startSkate.max=this.selector.width()-this.startSkate.width()-parseInt(this.startSkate.css("border-width"),10),this.options.range&&(this.coordinates.endSkate.max=this.selector.width()-this.endSkate.width()-parseInt(this.endSkate.css("border-width"),10))},this.select=function(b){if(b!==this.selectedYear){var c=a('.ds-category-item[data-year="'+b+'"]');if(!c.length)return console.warn("RangeRover -> select: element `"+b+"` is not found."),this;var d=c.offset().left;this.skate.css("left",d),this.selectedYear=b,this.updateSelectedYear(),this.options.onChange&&"function"==typeof this.options.onChange&&this.onChange()}return this}};b.autocalculateCategoriesSizes=function(a){var b=a.reduce(function(a,b,c){return 1===c?a.end-a.start+(b.end-b.start):a+(b.end-b.start)});return a.map(function(a){a.size=100/b*(a.end-a.start)})},b.getExcludedValuesPlain=function(b){var c=[];return a.each(b.exclude,function(a,b){if("object"==typeof b&&b.start&&b.end)for(var d=b.start;d<=b.end;d++)c.push(d);else c.push(b)}),c},b.isArray=function(a){if("[object Array]"===Object.prototype.toString.call(a))return!0},a.fn.extend({rangeRover:function(c){var d=new b;return d.options=a.extend(d.options,c),!d.options.data||b.isArray(d.options.data)&&!d.options.data.length?void console.warn("RangeRover -> please provide data"):(d.selector=a(this),d.init(),c.onInit&&"function"==typeof c.onInit&&c.onInit(),d)}})}(jQuery);

!function(t){var e=function(){this.options={range:!1,mode:"plain",autocalculate:!0,color:"#3498db",step:1,vLabels:!1},this.coordinates={startSkate:{min:0,max:0},endSkate:{min:0,max:0}},this.selector=null,this.startSkate=null,this.endSkate=null,this.progressBar=null,this.enabledSkater=null,this.selected={start:{value:0}},this.setEvendHandlers=function(){var e=this;e.startSkate.on("mousedown touchstart",function(){e.enabledSkater="startSkate"}),e.options.range&&e.endSkate.on("mousedown touchstart",function(){e.enabledSkater="endSkate"}),t(document).on("mouseup touchend",function(){e.checkSelection(null),e.enabledSkater=null}),t(document).on("mousemove touchmove",function(t){if(e.enabledSkater){e.checkSelection(null);var s=t.pageX-e.selector.offset().left;s<e.coordinates[e.enabledSkater].min?s=e.coordinates[e.enabledSkater].min:s>e.coordinates[e.enabledSkater].max&&(s=e.coordinates[e.enabledSkater].max),e[e.enabledSkater].css("left",s)}}),this.progressBar.on("click tap",function(t){e.progressBarSelection(t.pageX)})},this.init=function(){var s=this,a=[];"plain"===this.options.mode&&(s.options.data.size=100,s.options.data=[this.options.data]),s.selector.addClass("ds-container"),s.options.autocalculate&&"categorized"===this.options.mode&&e.autocalculateCategoriesSizes(s.options.data),t.each(s.options.data,function(t,n){var o=n.exclude?e.getExcludedValuesPlain(n):[],i='<div class="ds-category" data-category="'+(n.id||n.name)+'" style="width:'+n.size+"%;"+(n.color?"background:"+n.color:"")+'"><span class="ds-category-title">'+(n.name?n.name:"")+'</span><span class="ds-category-start">'+n.start+"</span>",r=n.end-n.start-o.length,d=s.selector.width()/100*n.size/r,c=0;s.selected.start.value=n.start,"categorized"===s.options.mode&&(s.selected.start.category=n.id||n.name);for(var l=n.start;l<n.end;l++)c=l,l+s.options.step-1>n.end&&(c=n.end),~o.indexOf(l)||(i+='<span class="ds-item" data-year="'+c+'" style="width:'+d*s.options.step+'px">'+(s.options.vLabels&&l!=n.start&&l!=n.end?l:"")+"</span>",l=l+s.options.step-1);t===s.options.data.length-1&&(i+='<span class="ds-category-end">'+n.end+"</span>",s.options.range&&(s.selected.end={},s.selected.end.value=n.end,"categorized"===s.options.mode&&(s.selected.end.category=n.id||n.name))),i+="</div>",a.push(i)});var n='<div class="ds-skate"><span class="ds-skate-year-mark">'+s.selected.start.value+'</span></div><div class="ds-progress">'+a.join("")+" </div>";this.options.range&&(n+='<div class="ds-end-skate"><span class="ds-skate-year-mark">'+s.selected.end.value+"</span></div>"),this.selector.html(n),this.startSkate=this.selector.find(".ds-skate"),this.options.range&&(this.endSkate=this.selector.find(".ds-end-skate")),this.progressBar=this.selector.find(".ds-progress"),this.options.color&&this.progressBar.css("background",this.options.color),this.selector.attr("ondragstart","return false"),this.calculateAndSetCoordinates(),this.setEvendHandlers()},this.checkSelection=function(e){var s,a,n=this,o=null;if(!!e)n.options.range||(o="start"),n.options.range&&parseInt(n.endSkate.css("left"),10)-e<e-parseInt(n.startSkate.css("left"),10)?(n.endSkate.css("left",e),o="end"):(n.startSkate.css("left",e),o="start");else{if(!n[n.enabledSkater])return;e=parseInt(n[n.enabledSkater].css("left"),10)}"endSkate"===n.enabledSkater&&e===this.coordinates.endSkate.max&&("categorized"===n.options.mode?(s=n.options.data[n.options.data.length-1].end,a=n.options.data[n.options.data.length-1].name):s=n.options.data[0].end),s||n.progressBar.find(".ds-item").each(function(o,i){var r=(i=t(i)).offset().left-n.selector.offset().left;if(r<=e&&r+i.width()>e)return s=+i.attr("data-year"),a=i.parent().attr("data-category"),!1}),o=o||(n.enabledSkater?n.enabledSkater.split("Skate")[0]:null),s&&s!==this.selected[o].value&&(n.selected[o].value=+s,"categorized"===n.options.mode&&(n.selected[o].category=a),n.updateSelectedLabels(),n.options.onChange&&"function"==typeof n.options.onChange&&n.onChange())},this.onChange=function(){this.options.onChange(this.selected)},this.progressBarSelection=function(e){this.checkSelection(e-t(".ds-container").offset().left)},this.updateSelectedLabels=function(){this.updateCoordinates(),this.startSkate.children(".ds-skate-year-mark").html(this.selected.start.value),this.options.range&&this.endSkate.children(".ds-skate-year-mark").html(this.selected.end.value)},this.updateCoordinates=function(){this.options.range&&(this.coordinates.startSkate.max=parseInt(this.endSkate.css("left"),10),this.coordinates.endSkate.min=parseInt(this.startSkate.css("left"),10))},this.calculateAndSetCoordinates=function(){this.coordinates.startSkate.max=this.selector.width()-this.startSkate.width()-parseInt(this.startSkate.css("border-width"),10),this.options.range&&(this.coordinates.endSkate.max=this.selector.width()-this.endSkate.width()-parseInt(this.endSkate.css("border-width"),10))},this.select=function(e){if(e!==this.selectedYear){var s=t('.ds-category-item[data-year="'+e+'"]');if(!s.length)return console.warn("RangeRover -> select: element `"+e+"` is not found."),this;var a=s.offset().left;this.skate.css("left",a),this.selectedYear=e,this.updateSelectedYear(),this.options.onChange&&"function"==typeof this.options.onChange&&this.onChange()}return this}};e.autocalculateCategoriesSizes=function(t){var e=t.reduce(function(t,e,s){return 1===s?t.end-t.start+(e.end-e.start):t+(e.end-e.start)});return t.map(function(t){t.size=100/e*(t.end-t.start)})},e.getExcludedValuesPlain=function(e){var s=[];return t.each(e.exclude,function(t,e){if("object"==typeof e&&e.start&&e.end)for(var a=e.start;a<=e.end;a++)s.push(a);else s.push(e)}),s},e.isArray=function(t){if("[object Array]"===Object.prototype.toString.call(t))return!0},t.fn.extend({rangeRover:function(s){var a=new e;if(a.options=t.extend(a.options,s),!a.options.data||e.isArray(a.options.data)&&!a.options.data.length)console.warn("RangeRover -> please provide data");else if("plain"!==a.options.mode||!e.isArray(a.options.data)&&"object"==typeof a.options.data){if("categorized"!==a.options.mode||e.isArray(a.options.data))return a.selector=t(this),a.init(),s.onInit&&"function"==typeof s.onInit&&s.onInit(),a;console.warn("RangeRover -> `data` must be array in `categorized` mode")}else console.warn("RangeRover -> `data` must be object in `plain` mode")}})}(jQuery);
